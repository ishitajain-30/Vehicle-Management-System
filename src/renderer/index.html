<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vehicle Management System</title>
    <link rel="stylesheet" href="main.css" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ðŸš— Vehicle Management System</h1>
        <div class="nav-tabs">
          <button class="nav-btn active" onclick="showSection('dashboard')">
            Dashboard
          </button>
          <button class="nav-btn" onclick="showSection('purchase')">
            Add Purchase
          </button>
          <button class="nav-btn" onclick="showSection('sale')">
            Add Sale
          </button>
          <button class="nav-btn" onclick="showSection('inventory')">
            Inventory
          </button>
          <button class="nav-btn" onclick="showSection('reports')">
            Reports
          </button>
        </div>
      </div>

      <!-- Dashboard Section -->
      <div id="dashboard" class="content-section active">
        <h2>ðŸ“Š Dashboard Overview</h2>
        <div class="dashboard-cards" id="dashboardCards">
          <!-- Dashboard cards will be populated by JavaScript -->
        </div>

        <div class="search-box">
          <input
            type="text"
            id="globalSearch"
            placeholder="Search vehicles by chassis number, model, or customer name..."
          />
        </div>

        <div class="table-container">
          <table class="data-table" id="searchResults">
            <thead>
              <tr>
                <th>Chassis No</th>
                <th>Model</th>
                <th>Color</th>
                <th>Purchase Date</th>
                <th>Customer</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="searchResultsBody">
              <!-- Search results will be populated here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Purchase Section -->
      <div id="purchase" class="content-section">
        <h2>ðŸ›’ Add New Purchase</h2>
        <form id="purchaseForm">
          <div class="form-row">
            <div class="form-group">
              <label for="purchaseDate">Purchase Date</label>
              <input type="date" id="purchaseDate" required />
            </div>
            <div class="form-group">
              <label for="modelName">Model Name</label>
              <input
                type="text"
                id="modelName"
                placeholder="e.g., Honda City"
                required
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="chassisNo">Chassis Number</label>
              <input
                type="text"
                id="chassisNo"
                placeholder="Unique chassis number"
                required
              />
            </div>
            <div class="form-group">
              <label for="color">Color</label>
              <input
                type="text"
                id="color"
                placeholder="e.g., Red, Blue"
                required
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="purchasePrice">Purchase Price (â‚¹)</label>
              <input
                type="number"
                id="purchasePrice"
                step="0.01"
                placeholder="0.00"
                required
              />
            </div>
            <div class="form-group">
              <label for="transportCost">Transport Cost (â‚¹)</label>
              <input
                type="number"
                id="transportCost"
                step="0.01"
                placeholder="0.00"
              />
            </div>
          </div>

          <div class="form-group">
            <label for="accessoriesCost">Accessories Cost (â‚¹)</label>
            <input
              type="number"
              id="accessoriesCost"
              step="0.01"
              placeholder="0.00"
            />
          </div>

          <button type="submit" class="btn btn-success">Add Purchase</button>
        </form>
      </div>

      <!-- Sale Section -->
      <div id="sale" class="content-section">
        <h2>ðŸ’° Add New Sale</h2>
        <form id="saleForm">
          <div class="form-row">
            <div class="form-group">
              <label for="saleChassisNo">Select Vehicle</label>
              <select id="saleChassisNo" required>
                <option value="">Select chassis number...</option>
              </select>
            </div>
            <div class="form-group">
              <label for="customerName">Customer Name</label>
              <input
                type="text"
                id="customerName"
                placeholder="Customer full name"
                required
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="saleDate">Sale Date</label>
              <input type="date" id="saleDate" required />
            </div>
            <div class="form-group">
              <label for="salesPrice">Sale Price (â‚¹)</label>
              <input
                type="number"
                id="salesPrice"
                step="0.01"
                placeholder="0.00"
                required
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="insuranceCost">Insurance Cost (â‚¹)</label>
              <input
                type="number"
                id="insuranceCost"
                step="0.01"
                placeholder="0.00"
              />
            </div>
            <div class="form-group">
              <label for="taxRegistrationCost"
                >Tax & Registration Cost (â‚¹)</label
              >
              <input
                type="number"
                id="taxRegistrationCost"
                step="0.01"
                placeholder="0.00"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="registrationDate">Registration Date</label>
              <input type="date" id="registrationDate" />
            </div>
            <div class="form-group">
              <label for="paymentType">Payment Type</label>
              <select id="paymentType" required>
                <option value="">Select payment type...</option>
                <option value="cash">Cash</option>
                <option value="disbursment">Disbursement</option>
                <option value="bank_transfer">Bank Transfer</option>
                <option value="return_vehicle">Return Vehicle</option>
              </select>
            </div>
          </div>

          <button type="submit" class="btn btn-success">Add Sale</button>
        </form>
      </div>

      <!-- Inventory Section -->
      <div id="inventory" class="content-section">
        <h2>ðŸ“¦ Vehicle Inventory</h2>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Chassis No</th>
                <th>Model</th>
                <th>Color</th>
                <th>Purchase Date</th>
                <th>Purchase Price</th>
                <th>Total Cost</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="inventoryTableBody">
              <!-- Inventory data will be populated here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Reports Section -->
      <div id="reports" class="content-section">
        <h2>ðŸ“ˆ Profit Reports</h2>

        <div class="filters">
          <div class="form-group">
            <label for="filterPaymentType">Payment Type</label>
            <select id="filterPaymentType">
              <option value="">All Payment Types</option>
              <option value="cash">Cash</option>
              <option value="disbursment">Disbursement</option>
              <option value="bank_transfer">Bank Transfer</option>
              <option value="return_vehicle">Return Vehicle</option>
            </select>
          </div>

          <div class="form-group">
            <label for="filterMonth">Month</label>
            <select id="filterMonth">
              <option value="">All Months</option>
              <option value="01">January</option>
              <option value="02">February</option>
              <option value="03">March</option>
              <option value="04">April</option>
              <option value="05">May</option>
              <option value="06">June</option>
              <option value="07">July</option>
              <option value="08">August</option>
              <option value="09">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
          </div>

          <div class="form-group">
            <label for="filterYear">Year</label>
            <select id="filterYear">
              <option value="">All Years</option>
            </select>
          </div>

          <div class="form-group">
            <label for="filterModel">Model</label>
            <input type="text" id="filterModel" placeholder="Model name" />
          </div>

          <div class="form-group" style="display: flex; align-items: end">
            <button type="button" class="btn" onclick="applyFilters()">
              Apply Filters
            </button>
          </div>
        </div>

        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Chassis No</th>
                <th>Model</th>
                <th>Customer</th>
                <th>Purchase Date</th>
                <th>Sale Date</th>
                <th>Sale Price</th>
                <th>Total Cost</th>
                <th>Profit</th>
                <th>Profit %</th>
                <th>Payment Type</th>
              </tr>
            </thead>
            <tbody id="reportsTableBody">
              <!-- Reports data will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Modal for messages -->
    <div id="messageModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalTitle">Message</h3>
          <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div id="modalMessage"></div>
        <div style="margin-top: 20px; text-align: right">
          <button class="btn" onclick="closeModal()">OK</button>
        </div>
      </div>
    </div>

    <script>
      const { ipcRenderer } = require("electron");

      // Global variables
      let availableVehicles = [];
      let dashboardData = {};

      // Initialize the application
      document.addEventListener("DOMContentLoaded", function () {
        loadDashboard();
        loadAvailableVehicles();
        populateYearFilter();

        // Set default dates
        document.getElementById("purchaseDate").valueAsDate = new Date();
        document.getElementById("saleDate").valueAsDate = new Date();

        // Add event listeners
        document
          .getElementById("purchaseForm")
          .addEventListener("submit", handlePurchaseSubmit);
        document
          .getElementById("saleForm")
          .addEventListener("submit", handleSaleSubmit);
        document
          .getElementById("globalSearch")
          .addEventListener("input", handleGlobalSearch);

        // Debounce search
        let searchTimeout;
        document
          .getElementById("globalSearch")
          .addEventListener("input", function () {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(handleGlobalSearch, 300);
          });
      });

      // Navigation functions
      function showSection(sectionName) {
        // Hide all sections
        document.querySelectorAll(".content-section").forEach((section) => {
          section.classList.remove("active");
        });

        // Remove active class from all nav buttons
        document.querySelectorAll(".nav-btn").forEach((btn) => {
          btn.classList.remove("active");
        });

        // Show selected section
        document.getElementById(sectionName).classList.add("active");

        // Add active class to clicked button
        event.target.classList.add("active");

        // Load section-specific data
        switch (sectionName) {
          case "dashboard":
            loadDashboard();
            break;
          case "sale":
            loadAvailableVehicles();
            break;
          case "inventory":
            loadInventory();
            break;
          case "reports":
            loadReports();
            break;
        }
      }

      // Dashboard functions
      async function loadDashboard() {
        try {
          const result = await ipcRenderer.invoke("db-get-dashboard-data");
          if (result.success) {
            dashboardData = result.data;
            renderDashboardCards();
          } else {
            showMessage(
              "Error",
              "Failed to load dashboard data: " + result.error,
              "error"
            );
          }
        } catch (error) {
          showMessage(
            "Error",
            "Failed to load dashboard: " + error.message,
            "error"
          );
        }
      }

      function renderDashboardCards() {
        const cardsContainer = document.getElementById("dashboardCards");
        cardsContainer.innerHTML = `
                <div class="dashboard-card">
                    <h3>${dashboardData.totalVehicles?.count || 0}</h3>
                    <p>Total Vehicles</p>
                </div>
                <div class="dashboard-card">
                    <h3>${dashboardData.availableVehicles?.count || 0}</h3>
                    <p>Available Vehicles</p>
                </div>
                <div class="dashboard-card">
                    <h3>${dashboardData.soldVehicles?.count || 0}</h3>
                    <p>Sold Vehicles</p>
                </div>
                <div class="dashboard-card">
                    <h3>â‚¹${(
                      dashboardData.totalProfit?.total || 0
                    ).toLocaleString()}</h3>
                    <p>Total Profit</p>
                </div>
            `;
      }

      // Purchase form handling
      async function handlePurchaseSubmit(event) {
        event.preventDefault();

        const formData = {
          purchase_date: document.getElementById("purchaseDate").value,
          model_name: document.getElementById("modelName").value,
          chassis_no: document.getElementById("chassisNo").value,
          color: document.getElementById("color").value,
          purchase_price: parseFloat(
            document.getElementById("purchasePrice").value
          ),
          transport_cost:
            parseFloat(document.getElementById("transportCost").value) || 0,
          accessories_cost:
            parseFloat(document.getElementById("accessoriesCost").value) || 0,
        };

        try {
          const result = await ipcRenderer.invoke("db-add-purchase", formData);
          if (result.success) {
            showMessage(
              "Success",
              "Vehicle purchase added successfully!",
              "success"
            );
            document.getElementById("purchaseForm").reset();
            document.getElementById("purchaseDate").valueAsDate = new Date();
            loadDashboard();
          } else {
            showMessage(
              "Error",
              "Failed to add purchase: " + result.error,
              "error"
            );
          }
        } catch (error) {
          showMessage(
            "Error",
            "Failed to add purchase: " + error.message,
            "error"
          );
        }
      }

      // Sale form handling
      async function handleSaleSubmit(event) {
        event.preventDefault();

        const formData = {
          chassis_no: document.getElementById("saleChassisNo").value,
          customer_name: document.getElementById("customerName").value,
          sale_date: document.getElementById("saleDate").value,
          sales_price: parseFloat(document.getElementById("salesPrice").value),
          insurance_cost:
            parseFloat(document.getElementById("insuranceCost").value) || 0,
          tax_registration_cost:
            parseFloat(document.getElementById("taxRegistrationCost").value) ||
            0,
          registration_date: document.getElementById("registrationDate").value,
          payment_type: document.getElementById("paymentType").value,
        };

        try {
          const result = await ipcRenderer.invoke("db-add-sale", formData);
          if (result.success) {
            showMessage(
              "Success",
              "Vehicle sale added successfully!",
              "success"
            );
            document.getElementById("saleForm").reset();
            document.getElementById("saleDate").valueAsDate = new Date();
            loadAvailableVehicles();
            loadDashboard();
          } else {
            showMessage(
              "Error",
              "Failed to add sale: " + result.error,
              "error"
            );
          }
        } catch (error) {
          showMessage("Error", "Failed to add sale: " + error.message, "error");
        }
      }

      // Load available vehicles for sale dropdown
      async function loadAvailableVehicles() {
        try {
          const result = await ipcRenderer.invoke("db-get-available-vehicles");
          if (result.success) {
            availableVehicles = result.data;
            populateVehicleDropdown();
          } else {
            showMessage(
              "Error",
              "Failed to load available vehicles: " + result.error,
              "error"
            );
          }
        } catch (error) {
          showMessage(
            "Error",
            "Failed to load vehicles: " + error.message,
            "error"
          );
        }
      }

      function populateVehicleDropdown() {
        const dropdown = document.getElementById("saleChassisNo");
        dropdown.innerHTML =
          '<option value="">Select chassis number...</option>';

        availableVehicles.forEach((vehicle) => {
          const option = document.createElement("option");
          option.value = vehicle.chassis_no;
          option.textContent = `${vehicle.chassis_no} - ${vehicle.model_name} (${vehicle.color})`;
          dropdown.appendChild(option);
        });
      }

      // Load inventory
      async function loadInventory() {
        try {
          const result = await ipcRenderer.invoke("db-get-available-vehicles");
          if (result.success) {
            renderInventoryTable(result.data);
          } else {
            showMessage(
              "Error",
              "Failed to load inventory: " + result.error,
              "error"
            );
          }
        } catch (error) {
          showMessage(
            "Error",
            "Failed to load inventory: " + error.message,
            "error"
          );
        }
      }

      function renderInventoryTable(vehicles) {
        const tbody = document.getElementById("inventoryTableBody");
        tbody.innerHTML = "";

        vehicles.forEach((vehicle) => {
          const totalCost =
            vehicle.purchase_price +
            (vehicle.transport_cost || 0) +
            (vehicle.accessories_cost || 0);
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${vehicle.chassis_no}</td>
                    <td>${vehicle.model_name}</td>
                    <td>${vehicle.color}</td>
                    <td>${formatDate(vehicle.purchase_date)}</td>
                    <td>â‚¹${vehicle.purchase_price.toLocaleString()}</td>
                    <td>â‚¹${totalCost.toLocaleString()}</td>
                    <td><span style="color: #28a745; font-weight: bold;">Available</span></td>
                `;
          tbody.appendChild(row);
        });
      }

      // Reports functions
      async function loadReports() {
        try {
          const result = await ipcRenderer.invoke("db-get-profit-report", {});
          if (result.success) {
            renderReportsTable(result.data);
          } else {
            showMessage(
              "Error",
              "Failed to load reports: " + result.error,
              "error"
            );
          }
        } catch (error) {
          showMessage(
            "Error",
            "Failed to load reports: " + error.message,
            "error"
          );
        }
      }

      async function applyFilters() {
        const filters = {
          payment_type: document.getElementById("filterPaymentType").value,
          month: document.getElementById("filterMonth").value,
          year: document.getElementById("filterYear").value,
          model_name: document.getElementById("filterModel").value,
        };

        // Remove empty filters
        Object.keys(filters).forEach((key) => {
          if (!filters[key]) delete filters[key];
        });

        try {
          const result = await ipcRenderer.invoke(
            "db-get-profit-report",
            filters
          );
          if (result.success) {
            renderReportsTable(result.data);
          } else {
            showMessage(
              "Error",
              "Failed to apply filters: " + result.error,
              "error"
            );
          }
        } catch (error) {
          showMessage(
            "Error",
            "Failed to apply filters: " + error.message,
            "error"
          );
        }
      }

      function renderReportsTable(reports) {
        const tbody = document.getElementById("reportsTableBody");
        tbody.innerHTML = "";

        reports.forEach((report) => {
          const totalCost =
            report.purchase_price +
            (report.transport_cost || 0) +
            (report.accessories_cost || 0) +
            (report.insurance_cost || 0) +
            (report.tax_registration_cost || 0);

          const row = document.createElement("tr");
          const profitColor = report.profit >= 0 ? "#28a745" : "#dc3545";

          row.innerHTML = `
                    <td>${report.chassis_no}</td>
                    <td>${report.model_name}</td>
                    <td>${report.customer_name}</td>
                    <td>${formatDate(report.purchase_date)}</td>
                    <td>${formatDate(report.sale_date)}</td>
                    <td>â‚¹${report.sales_price.toLocaleString()}</td>
                    <td>â‚¹${totalCost.toLocaleString()}</td>
                    <td style="color: ${profitColor}; font-weight: bold;">â‚¹${report.profit.toLocaleString()}</td>
                    <td style="color: ${profitColor}; font-weight: bold;">${
            report.profit_percentage
          }%</td>
                    <td>${report.payment_type}</td>
                `;
          tbody.appendChild(row);
        });
      }

      // Search functionality
      async function handleGlobalSearch() {
        const searchTerm = document.getElementById("globalSearch").value.trim();

        if (searchTerm.length < 2) {
          document.getElementById("searchResultsBody").innerHTML = "";
          return;
        }

        try {
          const result = await ipcRenderer.invoke(
            "db-search-vehicles",
            searchTerm
          );
          if (result.success) {
            renderSearchResults(result.data);
          } else {
            showMessage("Error", "Search failed: " + result.error, "error");
          }
        } catch (error) {
          showMessage("Error", "Search failed: " + error.message, "error");
        }
      }

      function renderSearchResults(vehicles) {
        const tbody = document.getElementById("searchResultsBody");
        tbody.innerHTML = "";

        vehicles.forEach((vehicle) => {
          const row = document.createElement("tr");
          const status = vehicle.customer_name ? "Sold" : "Available";
          const statusColor = vehicle.customer_name ? "#dc3545" : "#28a745";

          row.innerHTML = `
                    <td>${vehicle.chassis_no}</td>
                    <td>${vehicle.model_name}</td>
                    <td>${vehicle.color}</td>
                    <td>${formatDate(vehicle.purchase_date)}</td>
                    <td>${vehicle.customer_name || "-"}</td>
                    <td style="color: ${statusColor}; font-weight: bold;">${status}</td>
                `;
          tbody.appendChild(row);
        });
      }

      // Utility functions
      function populateYearFilter() {
        const yearSelect = document.getElementById("filterYear");
        const currentYear = new Date().getFullYear();

        for (let year = currentYear; year >= currentYear - 10; year--) {
          const option = document.createElement("option");
          option.value = year;
          option.textContent = year;
          yearSelect.appendChild(option);
        }
      }

      function formatDate(dateString) {
        if (!dateString) return "-";
        const date = new Date(dateString);
        return date.toLocaleDateString("en-IN");
      }

      function showMessage(title, message, type) {
        document.getElementById("modalTitle").textContent = title;
        document.getElementById("modalMessage").textContent = message;
        document.getElementById("messageModal").style.display = "block";

        // Add color based on type
        const modal = document.querySelector(".modal-content");
        modal.style.borderLeft =
          type === "success" ? "5px solid #28a745" : "5px solid #dc3545";
      }

      function closeModal() {
        document.getElementById("messageModal").style.display = "none";
      }

      // Close modal when clicking outside
      window.onclick = function (event) {
        const modal = document.getElementById("messageModal");
        if (event.target === modal) {
          closeModal();
        }
      };
    </script>
  </body>
</html>
